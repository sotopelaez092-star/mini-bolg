# FastAPI Mini Blog - 产品需求文档 (PRD)

## 📋 文档信息

- **项目名称**: FastAPI Mini Blog
- **版本**: v1.0
- **创建日期**: 2025-10-14
- **文档状态**: 草案
- **项目类型**: 学习实战项目

---

## 1. 项目概述

### 1.1 项目背景
FastAPI Mini Blog 是一个轻量级的博客系统，旨在通过实战项目学习和掌握 FastAPI 框架的核心功能，包括 RESTful API 设计、数据库操作、用户认证、权限管理等。

### 1.2 项目目标
- 构建一个功能完整的博客后端系统
- 学习 FastAPI 的最佳实践
- 掌握现代 Web 开发的常用技术栈
- 积累可展示的项目作品

### 1.3 项目范围
**包含内容**:
- 用户认证与授权系统
- 文章管理（CRUD）
- 评论系统
- 分类和标签
- 搜索功能
- RESTful API

**不包含内容** (MVP 阶段):
- 前端界面
- 实时通知
- 社交分享功能
- 富文本编辑器（前端功能）

---

## 2. 目标用户

### 2.1 主要用户角色

**博客作者**
- 需要发布和管理自己的文章
- 需要回复读者评论
- 需要管理文章分类和标签

**普通读者**
- 浏览和阅读文章
- 搜索感兴趣的内容
- 发表评论与作者互动

**管理员**
- 管理所有用户和内容
- 删除不当评论
- 维护系统正常运行

---

## 3. 功能需求

### 3.1 用户认证系统

#### 3.1.1 用户注册
**功能描述**: 新用户可以注册账号

**输入**:
- 用户名（唯一，3-20 字符）
- 邮箱（唯一，需验证格式）
- 密码（8-50 字符，需包含字母和数字）
- 昵称（可选，2-20 字符）

**输出**:
- 注册成功：返回用户信息（不含密码）
- 注册失败：返回错误信息

**验证规则**:
- 用户名和邮箱唯一性检查
- 密码强度验证
- 邮箱格式验证

#### 3.1.2 用户登录
**功能描述**: 已注册用户使用凭证登录

**输入**:
- 用户名或邮箱
- 密码

**输出**:
- 登录成功：返回 JWT token 和用户信息
- 登录失败：返回错误信息

**业务规则**:
- Token 有效期：30 分钟
- 支持 Token 刷新机制
- 密码错误次数限制（可选）

#### 3.1.3 用户信息管理
**功能描述**: 用户可以查看和更新个人信息

**可更新字段**:
- 昵称
- 邮箱（需验证）
- 密码（需提供旧密码）
- 个人简介
- 头像 URL

**权限**: 仅本人可修改

---

### 3.2 文章管理系统

#### 3.2.1 创建文章
**功能描述**: 已登录用户可以创建新文章

**输入**:
- 标题（必填，1-200 字符）
- 内容（必填，Markdown 格式）
- 摘要（可选，最多 500 字符）
- 分类 ID（可选）
- 标签列表（可选，最多 5 个）
- 封面图 URL（可选）
- 发布状态（草稿/已发布）

**输出**:
- 文章详细信息（包含 ID、创建时间等）

**业务规则**:
- 每个用户每天最多发布 10 篇文章（可配置）
- 标题不可重复（同一作者）

#### 3.2.2 编辑文章
**功能描述**: 作者可以编辑自己的文章

**可编辑字段**: 同创建文章

**权限**: 仅作者本人或管理员

**业务规则**:
- 记录最后更新时间
- 已发布文章修改后保持发布状态

#### 3.2.3 删除文章
**功能描述**: 作者可以删除自己的文章

**删除方式**: 软删除（标记为已删除，不从数据库移除）

**权限**: 仅作者本人或管理员

**关联处理**: 
- 文章下的所有评论同时软删除

#### 3.2.4 文章列表
**功能描述**: 获取文章列表，支持多种筛选和排序

**查询参数**:
- 分页：page（页码）、size（每页数量，默认 10，最大 50）
- 筛选：author_id（作者）、category_id（分类）、tag_id（标签）
- 排序：按创建时间、更新时间、浏览量（默认创建时间倒序）
- 状态：只显示已发布文章（对非作者）

**输出**:
- 文章列表（包含摘要）
- 分页信息（总数、当前页、总页数）

#### 3.2.5 文章详情
**功能描述**: 查看单篇文章的完整内容

**输出**:
- 文章完整信息
- 作者信息
- 分类和标签
- 评论数量
- 浏览次数

**业务规则**:
- 每次访问浏览量 +1（可加防刷机制）
- 草稿状态只有作者可见

#### 3.2.6 文章搜索
**功能描述**: 根据关键词搜索文章

**搜索范围**:
- 文章标题
- 文章内容
- 标签名称

**输出**: 符合条件的文章列表（同文章列表格式）

---

### 3.3 评论系统

#### 3.3.1 发表评论
**功能描述**: 已登录用户可以对文章发表评论

**输入**:
- 文章 ID（必填）
- 评论内容（必填，1-500 字符）
- 父评论 ID（可选，用于回复评论）

**输出**:
- 评论详细信息

**业务规则**:
- 只能对已发布的文章评论
- 评论深度最多 2 层（评论 -> 回复）

#### 3.3.2 删除评论
**功能描述**: 删除评论

**权限**: 
- 评论作者本人
- 文章作者
- 管理员

**删除方式**: 软删除

#### 3.3.3 获取评论列表
**功能描述**: 获取文章的评论列表

**输入**:
- 文章 ID
- 分页参数

**输出**:
- 评论列表（树形结构）
- 每条评论包含作者信息

**排序**: 按创建时间正序

---

### 3.4 分类和标签系统

#### 3.4.1 分类管理
**功能描述**: 管理文章分类

**CRUD 操作**:
- 创建分类（管理员）
- 编辑分类（管理员）
- 删除分类（管理员，需检查是否有文章使用）
- 查看分类列表（所有用户）

**分类属性**:
- 名称（唯一）
- 描述
- 排序权重

#### 3.4.2 标签管理
**功能描述**: 管理文章标签

**特点**:
- 用户创建文章时可以创建新标签
- 标签名称唯一
- 显示标签使用次数

**操作**:
- 查看所有标签
- 查看热门标签（按使用次数）
- 删除未使用的标签（管理员）

---

### 3.5 用户权限系统

#### 3.5.1 角色定义
- **普通用户**: 可以发文章、评论
- **管理员**: 拥有所有权限

#### 3.5.2 权限矩阵

| 功能 | 游客 | 普通用户 | 管理员 |
|------|------|----------|--------|
| 查看文章 | ✓ | ✓ | ✓ |
| 搜索文章 | ✓ | ✓ | ✓ |
| 发表文章 | ✗ | ✓ | ✓ |
| 编辑自己的文章 | ✗ | ✓ | ✓ |
| 删除自己的文章 | ✗ | ✓ | ✓ |
| 编辑他人文章 | ✗ | ✗ | ✓ |
| 删除他人文章 | ✗ | ✗ | ✓ |
| 发表评论 | ✗ | ✓ | ✓ |
| 删除自己评论 | ✗ | ✓ | ✓ |
| 删除他人评论 | ✗ | ✗ | ✓ |
| 管理分类 | ✗ | ✗ | ✓ |

---

## 4. 非功能需求

### 4.1 性能要求
- API 响应时间：< 200ms（P95）
- 支持并发：100 QPS
- 数据库查询优化（添加必要索引）

### 4.2 安全要求
- 密码使用 bcrypt 加密存储
- JWT Token 认证
- SQL 注入防护（使用 ORM）
- XSS 防护（输入验证）
- CORS 配置

### 4.3 可用性要求
- 清晰的错误提示
- 完善的 API 文档（Swagger UI）
- 标准的 HTTP 状态码
- 统一的响应格式

### 4.4 可维护性要求
- 代码遵循 PEP 8 规范
- 关键功能有单元测试
- 清晰的代码注释
- 模块化设计

---

## 5. 数据模型设计

### 5.1 User（用户表）
```
- id: UUID (主键)
- username: String (唯一, 索引)
- email: String (唯一, 索引)
- hashed_password: String
- nickname: String (可空)
- avatar_url: String (可空)
- bio: String (可空)
- is_active: Boolean (默认 True)
- is_admin: Boolean (默认 False)
- created_at: DateTime
- updated_at: DateTime
```

### 5.2 Post（文章表）
```
- id: UUID (主键)
- title: String (索引)
- content: Text
- summary: String (可空)
- cover_image: String (可空)
- author_id: UUID (外键 -> User, 索引)
- category_id: UUID (外键 -> Category, 可空)
- status: Enum (draft, published)
- view_count: Integer (默认 0)
- is_deleted: Boolean (默认 False)
- created_at: DateTime (索引)
- updated_at: DateTime
```

### 5.3 Comment（评论表）
```
- id: UUID (主键)
- post_id: UUID (外键 -> Post, 索引)
- user_id: UUID (外键 -> User, 索引)
- content: String
- parent_id: UUID (外键 -> Comment, 可空, 索引)
- is_deleted: Boolean (默认 False)
- created_at: DateTime
```

### 5.4 Category（分类表）
```
- id: UUID (主键)
- name: String (唯一)
- description: String (可空)
- sort_order: Integer (默认 0)
- created_at: DateTime
```

### 5.5 Tag（标签表）
```
- id: UUID (主键)
- name: String (唯一, 索引)
- created_at: DateTime
```

### 5.6 PostTag（文章标签关联表）
```
- post_id: UUID (外键 -> Post, 联合主键)
- tag_id: UUID (外键 -> Tag, 联合主键)
```

---

## 6. API 设计

### 6.1 API 基础信息
- Base URL: `/api/v1`
- 认证方式: Bearer Token (JWT)
- 请求格式: JSON
- 响应格式: JSON

### 6.2 标准响应格式

**成功响应**:
```json
{
  "data": {...},
  "message": "Success"
}
```

**错误响应**:
```json
{
  "detail": "Error message"
}
```

### 6.3 API 端点列表

#### 认证相关
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 用户登录
- `POST /auth/refresh` - 刷新 Token

#### 用户相关
- `GET /users/me` - 获取当前用户信息
- `PUT /users/me` - 更新当前用户信息
- `GET /users/{user_id}` - 获取用户公开信息

#### 文章相关
- `GET /posts` - 获取文章列表（分页、筛选、排序）
- `GET /posts/{post_id}` - 获取文章详情
- `POST /posts` - 创建文章（需认证）
- `PUT /posts/{post_id}` - 更新文章（需认证，需权限）
- `DELETE /posts/{post_id}` - 删除文章（需认证，需权限）
- `GET /posts/search` - 搜索文章

#### 评论相关
- `GET /posts/{post_id}/comments` - 获取文章评论列表
- `POST /posts/{post_id}/comments` - 发表评论（需认证）
- `DELETE /comments/{comment_id}` - 删除评论（需认证，需权限）

#### 分类相关
- `GET /categories` - 获取所有分类
- `GET /categories/{category_id}` - 获取分类详情
- `POST /categories` - 创建分类（需管理员）
- `PUT /categories/{category_id}` - 更新分类（需管理员）
- `DELETE /categories/{category_id}` - 删除分类（需管理员）

#### 标签相关
- `GET /tags` - 获取所有标签
- `GET /tags/popular` - 获取热门标签

---

## 7. 技术架构

### 7.1 技术栈
- **框架**: FastAPI 0.104+
- **Python**: 3.8+
- **数据库**: PostgreSQL 12+ (开发可用 SQLite)
- **ORM**: SQLAlchemy 2.0
- **数据验证**: Pydantic
- **认证**: JWT (python-jose)
- **密码加密**: Passlib + bcrypt
- **数据库迁移**: Alembic
- **测试**: Pytest

### 7.2 项目结构
```
fastapi-mini-blog/
├── app/
│   ├── api/v1/          # API 路由
│   ├── core/            # 核心功能
│   ├── models/          # 数据库模型
│   ├── schemas/         # Pydantic 模型
│   ├── crud/            # 数据库操作
│   ├── database.py      # 数据库连接
│   ├── config.py        # 配置
│   └── main.py          # 应用入口
├── tests/               # 测试
├── alembic/             # 数据库迁移
└── requirements.txt     # 依赖
```

---

## 8. 开发阶段规划

### Phase 1: 基础框架搭建 (Week 1)
- [x] 项目初始化
- [ ] 数据库模型设计
- [ ] Alembic 配置
- [ ] 基础配置和中间件

### Phase 2: 用户认证系统 (Week 2)
- [ ] User 模型和 Schema
- [ ] 密码加密工具
- [ ] JWT 工具函数
- [ ] 注册 API
- [ ] 登录 API
- [ ] 用户信息 API

### Phase 3: 文章管理系统 (Week 3)
- [ ] Post 模型和 Schema
- [ ] 创建文章 API
- [ ] 编辑文章 API
- [ ] 删除文章 API
- [ ] 文章列表 API
- [ ] 文章详情 API
- [ ] 搜索功能

### Phase 4: 评论系统 (Week 4)
- [ ] Comment 模型和 Schema
- [ ] 发表评论 API
- [ ] 评论列表 API
- [ ] 删除评论 API
- [ ] 评论树形结构处理

### Phase 5: 分类标签系统 (Week 5)
- [ ] Category 和 Tag 模型
- [ ] 分类 CRUD API
- [ ] 标签 API
- [ ] 文章关联分类标签

### Phase 6: 测试和优化 (Week 6)
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] 文档完善

---

## 9. 测试计划

### 9.1 单元测试
- 数据模型验证
- CRUD 操作
- 工具函数
- 业务逻辑

### 9.2 集成测试
- API 端点测试
- 认证流程测试
- 权限验证测试
- 数据关联测试

### 9.3 测试覆盖率目标
- 核心业务逻辑：> 80%
- API 端点：100%

---

## 10. 未来扩展功能

### 10.1 短期扩展 (v1.1 - v1.2)
- 文章点赞功能
- 文章收藏功能
- 关注作者功能
- 邮件通知
- 图片上传功能
- 文章草稿自动保存

### 10.2 中期扩展 (v2.0)
- 全文搜索（Elasticsearch）
- 文章推荐算法
- 用户等级系统
- 徽章成就系统
- 文章统计分析
- 敏感词过滤

### 10.3 长期扩展 (v3.0)
- 多租户支持
- 内容审核系统
- 付费文章功能
- API 限流和配额
- 缓存层（Redis）
- CDN 集成

---

## 11. 风险评估

### 11.1 技术风险
- **数据库性能**: 文章数量增长后的查询性能
  - 缓解措施: 添加索引、分页限制、缓存
  
- **并发问题**: 高并发下的数据一致性
  - 缓解措施: 使用事务、乐观锁

### 11.2 安全风险
- **SQL 注入**: 恶意 SQL 查询
  - 缓解措施: 使用 ORM 参数化查询
  
- **暴力破解**: 密码暴力尝试
  - 缓解措施: 登录限流、验证码（未来）

### 11.3 业务风险
- **垃圾内容**: 垃圾评论和文章
  - 缓解措施: 内容审核、举报机制（未来）

---

## 12. 成功指标

### 12.1 技术指标
- API 响应时间 P95 < 200ms
- 测试覆盖率 > 80%
- 零严重安全漏洞

### 12.2 学习目标
- 掌握 FastAPI 核心概念
- 理解 RESTful API 设计
- 熟悉数据库设计和优化
- 了解用户认证和授权流程

---

## 附录

### A. 参考资料
- FastAPI 官方文档: https://fastapi.tiangolo.com/
- SQLAlchemy 文档: https://docs.sqlalchemy.org/
- JWT 标准: https://jwt.io/

### B. 术语表
- **PRD**: Product Requirements Document，产品需求文档
- **CRUD**: Create, Read, Update, Delete，增删改查
- **JWT**: JSON Web Token，JSON 网络令牌
- **ORM**: Object-Relational Mapping，对象关系映射
- **MVP**: Minimum Viable Product，最小可行产品